angular.module("angucomplete",[]).directive("angucomplete",["$parse","$http",function($parse,$http){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength"},template:'<div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" ng-keyup="keyPressed($event)"/><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">Searching...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">No results found</div><div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="result.image && result.image != \'\'" class="angucomplete-image-holder"><img ng-src="{{result.image}}" class="angucomplete-image"/></div><div>{{result.title}}</div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div>',controller:["$scope",function($scope){$scope.lastFoundWord=null,$scope.currentIndex=null,$scope.justChanged=!1,$scope.searchTimer=null,$scope.searching=!1,$scope.pause=500,$scope.minLength=3,$scope.minLengthUser&&""!=$scope.minLengthUser&&($scope.minLength=$scope.minLengthUser),$scope.userPause&&($scope.pause=$scope.userPause),$scope.processResults=function(responseData){if(responseData&&responseData.length>0){$scope.results=[];var titleFields=[];$scope.titleField&&""!=$scope.titleField&&(titleFields=$scope.titleField.split(","));for(var i=0;i<responseData.length;i++){for(var titleCode="",t=0;t<titleFields.length;t++)t>0&&(titleCode+=" + ' ' + "),titleCode=titleCode+"responseData[i]."+titleFields[t];var description="";$scope.descriptionField&&""!=$scope.descriptionField&&eval("description = responseData[i]."+$scope.descriptionField);var image="";$scope.imageField&&""!=$scope.imageField&&eval("image = responseData[i]."+$scope.imageField);var resultRow={title:eval(titleCode),description:description,image:image,originalObject:responseData[i]};$scope.results[$scope.results.length]=resultRow}}else $scope.results=[]},$scope.searchTimerComplete=function(str){if(str.length>=$scope.minLength)if($scope.localData){for(var searchFields=$scope.searchFields.split(","),matches=[],i=0;i<$scope.localData.length;i++){for(var match=!1,s=0;s<searchFields.length;s++){var evalStr="match = match || ($scope.localData[i]."+searchFields[s]+'.toLowerCase().indexOf("'+str.toLowerCase()+'") >= 0)';eval(evalStr)}match&&(matches[matches.length]=$scope.localData[i])}$scope.searching=!1,$scope.processResults(matches),$scope.$apply()}else $http.get($scope.url+str,{}).success(function(a,b,c,d){$scope.searching=!1,$scope.processResults(a)}).error(function(a,b,c,d){console.log("error")})},$scope.hoverRow=function(a){$scope.currentIndex=a},$scope.keyPressed=function(a){38!=a.which&&40!=a.which&&13!=a.which?$scope.searchStr&&""!=$scope.searchStr?$scope.searchStr.length>=$scope.minLength&&($scope.showDropdown=!0,$scope.currentIndex=-1,$scope.results=[],$scope.searchTimer&&clearTimeout($scope.searchTimer),$scope.searching=!0,$scope.searchTimer=setTimeout(function(){$scope.searchTimerComplete($scope.searchStr)},$scope.pause)):$scope.showDropdown=!1:a.preventDefault()},$scope.selectResult=function(a){$scope.searchStr=a.title,$scope.selectedObject=a,$scope.showDropdown=!1,$scope.results=[]}}],link:["$scope","elem","attrs","ctrl",function(a,b,c,d){b.bind("keyup",["event",function(b){40===b.which?(a.currentIndex+1<a.results.length&&(a.currentIndex++,a.$apply(),b.preventDefault,b.stopPropagation()),a.$apply()):38==b.which?a.currentIndex>=1&&(a.currentIndex--,a.$apply(),b.preventDefault,b.stopPropagation()):13==b.which?a.currentIndex>=0&&a.currentIndex<a.results.length?(a.selectResult(a.results[a.currentIndex]),a.$apply(),b.preventDefault,b.stopPropagation()):(a.results=[],a.$apply(),b.preventDefault,b.stopPropagation()):27==b.which?(a.results=[],a.showDropdown=!1,a.$apply()):8==b.which&&(a.selectedObject=null,a.$apply())}])}]}}]);