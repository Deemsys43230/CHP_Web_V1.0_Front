angular.module("angucomplete",[]).directive("angucomplete",function($parse,$http){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength"},template:'<div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" ng-keyup="keyPressed($event)"/><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">Searching...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">No results found</div><div class="angucomplete-row" ng-repeat="result in results" ng-click="selectResult(result)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="result.image && result.image != \'\'" class="angucomplete-image-holder"><img ng-src="{{result.image}}" class="angucomplete-image"/></div><div>{{result.title}}</div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div>',controller:function($scope){$scope.lastFoundWord=null,$scope.currentIndex=null,$scope.justChanged=!1,$scope.searchTimer=null,$scope.searching=!1,$scope.pause=500,$scope.minLength=3,$scope.minLengthUser&&""!=$scope.minLengthUser&&($scope.minLength=$scope.minLengthUser),$scope.userPause&&($scope.pause=$scope.userPause),$scope.processResults=function(responseData){if(responseData&&responseData.length>0){$scope.results=[];var titleFields=[];$scope.titleField&&""!=$scope.titleField&&(titleFields=$scope.titleField.split(","));for(var i=0;i<responseData.length;i++){for(var titleCode="",t=0;t<titleFields.length;t++)t>0&&(titleCode+=" + ' ' + "),titleCode=titleCode+"responseData[i]."+titleFields[t];var description="";$scope.descriptionField&&""!=$scope.descriptionField&&eval("description = responseData[i]."+$scope.descriptionField);var image="";$scope.imageField&&""!=$scope.imageField&&eval("image = responseData[i]."+$scope.imageField);var resultRow={title:eval(titleCode),description:description,image:image,originalObject:responseData[i]};$scope.results[$scope.results.length]=resultRow}}else $scope.results=[]},$scope.searchTimerComplete=function(str){if(str.length>=$scope.minLength)if($scope.localData){for(var searchFields=$scope.searchFields.split(","),matches=[],i=0;i<$scope.localData.length;i++){for(var match=!1,s=0;s<searchFields.length;s++){var evalStr="match = match || ($scope.localData[i]."+searchFields[s]+'.toLowerCase().indexOf("'+str.toLowerCase()+'") >= 0)';eval(evalStr)}match&&(matches[matches.length]=$scope.localData[i])}$scope.searching=!1,$scope.processResults(matches),$scope.$apply()}else $http.get($scope.url+str,{}).success(function(e){$scope.searching=!1,$scope.processResults(e)}).error(function(){console.log("error")})},$scope.hoverRow=function(e){$scope.currentIndex=e},$scope.keyPressed=function(e){38!=e.which&&40!=e.which&&13!=e.which?$scope.searchStr&&""!=$scope.searchStr?$scope.searchStr.length>=$scope.minLength&&($scope.showDropdown=!0,$scope.currentIndex=-1,$scope.results=[],$scope.searchTimer&&clearTimeout($scope.searchTimer),$scope.searching=!0,$scope.searchTimer=setTimeout(function(){$scope.searchTimerComplete($scope.searchStr)},$scope.pause)):$scope.showDropdown=!1:e.preventDefault()},$scope.selectResult=function(e){$scope.searchStr=e.title,$scope.selectedObject=e,$scope.showDropdown=!1,$scope.results=[]}},link:function(e,s){s.bind("keyup",function(s){40===s.which?(e.currentIndex+1<e.results.length&&(e.currentIndex++,e.$apply(),s.preventDefault,s.stopPropagation()),e.$apply()):38==s.which?e.currentIndex>=1&&(e.currentIndex--,e.$apply(),s.preventDefault,s.stopPropagation()):13==s.which?e.currentIndex>=0&&e.currentIndex<e.results.length?(e.selectResult(e.results[e.currentIndex]),e.$apply(),s.preventDefault,s.stopPropagation()):(e.results=[],e.$apply(),s.preventDefault,s.stopPropagation()):27==s.which?(e.results=[],e.showDropdown=!1,e.$apply()):8==s.which&&(e.selectedObject=null,e.$apply())})}}});